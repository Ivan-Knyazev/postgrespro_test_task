# Автоматическая установка и настройка PostgreSQL на удалённом сервере

Данный проект разработан для автоматической установки и настройки СУБД PostgreSQL на одном из двух удаленных серверов (Debian/Ubuntu или CentOS/AlmaLinux).

`Python`-скрипт анализирует загруженность указанных серверов и выбирает наименее нагруженный для установки. Затем происходит проверка работы БД на данном сервере (`SELECT 1`). Также реализована доп. функция: **тестирование подключения к БД** с другого сервера для пользователя `student`.

Всё реализовано согласно [Техническому Заданию](https://gist.github.com/sokolcati/f3acb339fe464aa222d67b2febf99354).


## Функционал

*   **Подключение по SSH:** Используется библиотека `fabric` для подключения к удаленным серверам по SSH с использованием приватного ключа.
*   **Оценка загруженности:** Происходит получение `load average` за последнюю минуту и количество процессоров (`nproc`) с каждого сервера и вычисление нормализованной нагрузки (`load average / nproc`).
*   **Выбор целевого сервера:** Скрипт определяет сервер с минимальной нормализованной нагрузкой как целевой для установки PostgreSQL.
*   **Определение ОС:** Автоматически определяется операционная система на целевом сервере (Debian-based или RHEL-based (CentOS/AlmaLinux)) для использования корректных команд. Это происходит посредством чтения данных их файла `/etc/os-release`.
*   **Установка PostgreSQL:** Скрипт устанавливает последнюю доступную версию PostgreSQL и пакет `postgresql-contrib` из стандартных репозиториев с помощью пакетных менеджеров `apt` или `dnf`.
*   **Базовая настройка:**
    *   Запускает и включает автозапуск сервиса PostgreSQL.
    *   Инициализирует базу данных на CentOS/AlmaLinux (`postgresql-setup --initdb`).
*   **Настройка доступа:**
    *   Настраивает PostgreSQL для приема соединений со всех IP-адресов (`listen_addresses = '*'`).
    *   Создает пользователя PostgreSQL (имя и пароль задаются в `.env`).
    *   Настраивает `pg_hba.conf` так, чтобы созданный пользователь мог подключаться к БД `postgres` только с IP-адреса второго (не целевого) сервера, используя парольную аутентификацию (`md5`).
*   **Настройка Firewall (AlmaLinux/CentOS):** Если целевой сервер работает на AlmaLinux/CentOS, скрипт настраивает `firewalld`, чтобы разрешить входящие подключения на порт PostgreSQL (5432/tcp) и SSH.
*   **Локальная проверка:** Выполняет `SELECT 1;` на целевом сервере через `psql` для подтверждения базовой работоспособности PostgreSQL после установки и настройки.
*   **Удаленная проверка соединения (доп. задание):**
    *   Копирует необходимые файлы (`check_postgres.py`, `.env`) на второй (не целевой) сервер.
    *   Создаёт временное виртуальное окружение на втором сервере и устанавливает туда все необходимые Python-зависимости.
    *   Запускает скрипт проверки на втором сервере для попытки подключения к PostgreSQL на целевом сервере с использованием учетных данных `student`. Это проверяет правила `pg_hba.conf` и сетевую доступность.
    *   Удаляет временные файлы и окружение со второго сервера после проверки.
*   **Информирование:** Выводится статус выполнения ключевых шагов в консоль.


## Предварительные требования

1.  **Два сервера:** Один под управлением Debian/Ubuntu, другой под управлением CentOS/AlmaLinux.
2.  **SSH Доступ:**
    *   На обоих серверах должен быть пользователь `root`.
    *   **Один и тот же** открытый SSH-ключ (`id_*.pub`) должен быть добавлен в файл `/root/.ssh/authorized_keys` на **обоих** серверах.
    *   У вас должен быть соответствующий закрытый ключ (`id_*`) на машине, с которой вы запускаете скрипт.
3.  **Локальная машина:**
    *   Установлен Python 3 версии.
    *   Установлен `pip`.
4.  **Файл `check_postgres.py`:** В директории со скриптом `deploy_postgres.py` должен находиться файл `check_postgres.py`, который будет скопирован на второй сервер для выполнения удаленной проверки.
5.  **Сетевая доступность:**
    *   Локальная машина должна иметь доступ по SSH к обоим серверам.
    *   Оба сервера должны иметь доступ друг к другу по сети (для проверки подключения к PostgreSQL).


## Инструкция по запуску (для Ubuntu)

1.  Клонируйте репозиторий:
    ```bash
    git clone https://github.com/Ivan-Knyazev/postgrespro_test_task
    cd postgrespro_test_task
    ```

2.  Создайте файл `.env` в корневой директории проекта, скопировав `.env.example`:
    ```bash
    cp .env.example .env
    ```

3.  Отредактируйте файл `.env`, указав актуальные значения:
    *   `PRIVATE_KEY_PATH`: Абсолютный или относительный путь к вашему **приватному** SSH-ключу.
    *   `SSH_PORT`: Порт SSH на удаленных серверах.
    *   `POSTGRES_USER`: Имя пользователя PostgreSQL, которое будет создано (`student` - по заданию).
    *   `POSTGRES_PASSWORD`: Пароль для пользователя PostgreSQL. **Используйте надежный пароль!**

4.  Создайте виртуальное окружение Python:
    ```bash
    python3 -m venv venv
    ```

5.  Активируйте только что созданное виртуальное окружение:
    ```bash
    source ./venv/bin/activate
    ```
    Убедитесь, что `venv` активировался - левее надписи с Вашим username и hostname должно появиться `(venv)`. Примерно так:
    ```
    (venv) ivan@Ivan-Lenovo:
    ```

6.  Установите зависимости Python:
    ```bash
    pip3 install -r requirements.txt
    ```

7.  Запустите скрипт, передав ему IP-адреса или DNS-имена двух серверов в виде строки через запятую:
    ```bash
    python3 deploy_postgres.py <server1_ip_or_hostname>,<server2_ip_or_hostname>
    ```

    Например:
    ```bash
    python3 deploy_postgres.py 192.168.1.41,192.168.1.43
    ```

8.  **Деактивация окружения (по завершении):** Просто введите команду `deactivate` в той же консоли.


## Инструкция по запуску (для Windows)

1.  **Клонируйте репозиторий:** Откройте Командную строку (`cmd.exe`) или `powershell` и выполните:
    ```bash
    git clone https://github.com/Ivan-Knyazev/postgrespro_test_task
    cd postgrespro_test_task
    ```

2.  **Создайте файл `.env`:** Скопируйте файл `.env.example` в `.env`. В PowerShell:
    ```powershell
    Copy-Item .env.example .env
    ```

3.  **Отредактируйте файл `.env`:** Откройте файл `.env` в текстовом редакторе (например, Блокнот, VS Code) и укажите актуальные значения:
    *   `PRIVATE_KEY_PATH`: Абсолютный или относительный путь к вашему **приватному** SSH-ключу. Используйте формат путей Windows (например, `C:\Users\YourUser\.ssh\id_ed25519` или `.\ssh_keys\id_ed25519`). Двойные обратные слэши (`\\`) обычно не требуются.
    *   `SSH_PORT`: Порт SSH на удаленных серверах.
    *   `POSTGRES_USER`: Имя пользователя PostgreSQL (`student` - по ТЗ).
    *   `POSTGRES_PASSWORD`: Пароль для пользователя PostgreSQL. **Используйте надежный пароль!**

4.  **Создайте виртуальное окружение Python:** В PowerShell:
    ```bash
    python -m venv venv
    ```

5.  **Активируйте виртуальное окружение:**
    *   В **Командной строке (`cmd.exe`)**:
        ```bash
        .\venv\Scripts\activate.bat
        ```
    *   В **PowerShell**:
        ```powershell
        .\venv\Scripts\Activate.ps1
        ```
        *Примечание: Если PowerShell выдает ошибку о невозможности запуска скриптов, вам может потребоваться изменить политику выполнения для текущего процесса командой (могут потребоваться права администратора): `Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process`*

    После успешной активации в начале строки приглашения командной строки должно появиться `(venv)`, например:
    ```
    (venv) C:\path\to\postgrespro_test_task>
    ```

6.  **Установите зависимости Python:** Убедитесь, что виртуальное окружение активно (`(venv)` в начале строки), и выполните:
    ```bash
    pip install -r requirements.txt
    ```

7.  **Запустите скрипт:** Передайте ему IP-адреса или DNS-имена двух серверов в виде строки через запятую:
    ```bash
    python deploy_postgres.py <server1_ip_or_hostname>,<server2_ip_or_hostname>
    ```

    Например:
    ```bash
    python deploy_postgres.py 192.168.1.41,192.168.1.43
    ```

8.  **Деактивация окружения (по завершении):** Просто введите команду `deactivate` в той же консоли.


## Тестирование

Для локального тестирования решения на ПК необходимо иметь гипервизор второго типа, на котором будут запущены необходимые виртуальные машины. Затем нужно удостовериться в доступности данных хостов, сгенерировать ssh-ключи, их открытую часть перебросить на виртуальные машины. После чего можно будет запускать скрипт, следуя инструкции выше.

Мною были проведены тестовые запуски полученного скрипта для проверки работоспособности полученного решения. Подробное описание процесса тестирования и подтверждающие логи приведены в файле [result.md](./result.md).


## Возникшие трудности

Во время разработки я столкнулся с определённым количеством трудностей.
1) Выбор python-библиотеки для разработки. Изначально хотел использовать библиотеку `paramiko`, затем на официальном сайте увидел информацию о новой библиотеке `fabric`. Изучив вкратце её возможности, я принял решение использовать её.
   
2) Для определения наиболее загруженного сервера сначала думал просто сравнивать значения `load average` за последнюю минуту. Но потом внимательней изучив, что на самом деле показывает данный параметр, понял, что необходимо ещё и учитывать количество процессоров (зачастую потоков процессора), поэтому ввёл новую рассчётную формулу, в которой просиходит деление `load average` за последнюю минуту на число процессоров на данном сервере. получаемых при помощи утилиты `nproc`.
   
3) Также возникла проблема с определением точного пути к конфигурационным файлам `postgres`, поскольку в своём составе они имеют директорию, название которой версия установленной СУБД, а она может быть разной. В качестве решеняи использовались стандартные команды в `psql` для получения пути к данным файлам. Также в случае, если эти команды не дадут ответа, то происходит поиск нужной версии напрямую в стандартной директории и самостоятельное формирование пути.
   
4) Также возникла проблема при утановке `postgres` на сервер с ОС `AlmaLinux`. Это выяснилось уже во время тестирования. Сервер СУБД устанавливался, но не стартавал. Как выяснилось, необходимо было выполнять дополнительную команду `postgresql-setup --initdb` для инициализации внутренней БД, необходимой для корректной работы `postgresql`.
   
5) Уже после выполнения доп. задания, во время тестирования подключения к СУБД, установленной на `AlmaLinux` с сервера на `Debian` возникла проблема подключения. Сервер не принимал входящие TCP-подключения на необходимый 5432 порт. Как оказалось, в `AlmaLinux` по-умолчанию работает сервис `firewalld`, который блокирует все подключения, кроме стандартных (таких как `ssh` на 22 порту). Поэтому в скрипт были добавлены команды для настройки данного файервола.
   
6) Во время запуска скрипта на `AlmaLinux` для тестирования подключения к СУБД на друггом сервере возникла проблема с python-зависимостями, которую также удалось решить, откорректировав список пакетов для установки через `dnf`.
   
7) Возникали ошибки при попытке утсановки модуля `psycopg2` для тестирования подключения к `postgres`. Проблема решилась использованием уже предскомпилированного модуля `psycopg2-binary`.

Таким образом, все проблемы удолось успешно решить. Было интересно с ними справляться и приятно в итоге получить рабочее решение. Тестирование также прошло успешно и была подтверждена работоспособность всех скриптов.


<hr>

Данное решение было разработано в рамках решения тестового задания для отбора на стажировкку в компанию PostgresPro по направлению DevOps.

Выполнил Князев Иван, 2 курс ИКН НИТУ МИСИС